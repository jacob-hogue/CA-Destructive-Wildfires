<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>California Wildfires</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/css/main.css">
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
    }
  </style>
  <script src="https://js.arcgis.com/4.30/"></script>
</head>
<body>
  <div id="viewDiv"></div>
  <div class="controls">
    <button id="startAnimation">Start Animation</button>
    <button id="stopAnimation">Stop Animation</button>
  </div>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/WebMap",
      "esri/layers/GeoJSONLayer",
      "esri/layers/GraphicsLayer",
      "esri/Graphic",
      "esri/geometry/geometryEngine" // Import for geometric operations
    ], function(Map, MapView, WebMap, GeoJSONLayer, GraphicsLayer, Graphic, geometryEngine) {

      // Create a WebMap instance using the web map ID
      var webMap = new WebMap({
        portalItem: { 
          id: "66b8501f53af47e6ae981214c4d9a32a" // your web map ID
        }
      });

      // Create a MapView instance
      var mapView = new MapView({
        container: "viewDiv", 
        map: webMap,
        center: [-118.805, 34.027], 
        zoom: 10 
      });

      // Create a GraphicsLayer with overall transparency
      var graphicsLayer = new GraphicsLayer({
        opacity: 0.86 // Set overall transparency to 14%
      });
      webMap.add(graphicsLayer);

      // Create a GeoJSONLayer instance
      var geojsonLayer = new GeoJSONLayer({
        url: "https://raw.githubusercontent.com/jacob-hogue/Deadly-Wildfires-New/main/Deadliest10.geojson",
        title: "California Top 10 Deadliest Wildfires"
      });

      // Add the GeoJSONLayer to the map
      webMap.add(geojsonLayer);

      // Variables for animation
      var animationActive = false;
      var animationInterval;
      var currentFeatureIndex = 0;
      var totalFeatures = 0;

      // Create a layer for centroids
      var centroidLayer = new GraphicsLayer();
      webMap.add(centroidLayer);

      // Wait until the layer is loaded
      geojsonLayer.when(function() {
        // Convert GeoJSON features to graphics
        geojsonLayer.queryFeatures().then(function(results) {
          results.features.forEach(function(feature) {
            var graphic = new Graphic({
              geometry: feature.geometry,
              attributes: feature.attributes,
              symbol: {
                type: "simple-fill",
                color: "#fc7b4c", 
                outline: {
                  color: "#9979d1", 
                  width: 1
                }
              }
            });
            graphicsLayer.add(graphic);

            // Calculate and add centroid for each fire extent
            var centroid = geometryEngine.centroid(feature.geometry);
            var centroidGraphic = new Graphic({
              geometry: centroid,
              attributes: feature.attributes,
              symbol: {
                type: "simple-marker",
                color: "yellow",
                size: 6
              }
            });
            centroidLayer.add(centroidGraphic);
          });

          // Apply blend mode and layer effect
          graphicsLayer.blendMode = "color-dodge"; 
          graphicsLayer.effect = "bloom(0.2, 3.1px, 0.1)"; 

          // Remove the GeoJSONLayer after conversion
          webMap.remove(geojsonLayer);
        });
      });

      // Function to zoom to a fire extent's centroid
      function zoomToFire(geometry, index) {
        mapView.goTo({
          target: geometry,
          zoom: 13, 
          duration: 2000
        });
      }

      // Function to start the animation
      function startAnimation() {
        if (animationActive) return;
        animationActive = true;
        totalFeatures = centroidLayer.graphics.length;

        // Start the animation
        animationInterval = setInterval(function() {
          if (currentFeatureIndex >= totalFeatures) {
            currentFeatureIndex = 0;  // Loop back to the first fire
          }

          var graphic = centroidLayer.graphics.getItemAt(currentFeatureIndex);
          zoomToFire(graphic.geometry, currentFeatureIndex);

          // Hide all other fire extents
          graphicsLayer.visible = false;
          graphicsLayer.definitionExpression = `OBJECTID = ${graphic.attributes.OBJECTID}`;
          graphicsLayer.visible = true;

          currentFeatureIndex++;  // Move to the next fire
        }, 10000); // 10 seconds delay between each zoom
      }

      // Function to stop the animation
      function stopAnimation() {
        clearInterval(animationInterval);
        animationActive = false;
      }

      document.getElementById("startAnimation").addEventListener("click", startAnimation);
      document.getElementById("stopAnimation").addEventListener("click", stopAnimation);
    });
  </script>
</body>
</html>
